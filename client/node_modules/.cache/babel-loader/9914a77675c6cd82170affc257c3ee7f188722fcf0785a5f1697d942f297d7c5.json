{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\RK\\\\Downloads\\\\opentalk_voice_app\\\\client\\\\src\\\\pages\\\\Call.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef, useState } from 'react';\nimport socket from '../socket'; // <-- yahan se lo, naya mat banao\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nlet pc;\nexport default function Call1({\n  user\n}) {\n  _s();\n  const remoteAudio = useRef();\n  const [inCall, setInCall] = useState(false);\n  const [partner, setPartner] = useState(null);\n  const [roomId, setRoomId] = useState(null);\n  useEffect(() => {\n    // mark online\n    socket.emit('iamonline', {\n      userId: user.id\n    });\n\n    // if a room was passed via query param (Connect navigates with ?room=...), start as initiator\n    const params = new URLSearchParams(window.location.search);\n    const roomFromUrl = params.get('room');\n    if (roomFromUrl) {\n      setRoomId(roomFromUrl);\n      // startPeer as initiator (true). errors logged.\n      startPeer(roomFromUrl).catch(err => console.error('startPeer error:', err));\n    }\n    const onMatched = async ({\n      roomId: rId,\n      partner: p\n    }) => {\n      setPartner(p);\n      setRoomId(rId);\n      await startPeer(rId);\n    };\n    const onOffer = async offer => {\n      // ensure peer connection exists for answer\n      if (!pc) await startPeer(roomId, false);\n      // set remote and create/send answer\n      await pc.setRemoteDescription(offer);\n      const answer = await pc.createAnswer();\n      await pc.setLocalDescription(answer);\n      socket.emit('answer', {\n        roomId,\n        answer\n      });\n    };\n    const onAnswer = async answer => {\n      if (pc) await pc.setRemoteDescription(answer);\n    };\n    const onIceCandidate = async candidate => {\n      if (pc) await pc.addIceCandidate(candidate);\n    };\n    socket.on('matched', onMatched);\n    socket.on('offer', onOffer);\n    socket.on('answer', onAnswer);\n    socket.on('ice-candidate', onIceCandidate);\n    return () => {\n      // don't disconnect shared socket here; just cleanup listeners and peer\n      try {\n        if (pc) {\n          pc.close();\n          pc = null;\n        }\n      } catch (e) {\n        console.warn('pc close error', e);\n      }\n      socket.off('matched', onMatched);\n      socket.off('offer', onOffer);\n      socket.off('answer', onAnswer);\n      socket.off('ice-candidate', onIceCandidate);\n\n      // remove unload handler\n      window.onbeforeunload = null;\n    };\n  }, []);\n  const startPeer = async (rId, initiator = true) => {\n    // create RTCPeerConnection\n    pc = new RTCPeerConnection();\n    setInCall(true);\n\n    // get only audio\n    let stream;\n    try {\n      stream = await navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: false\n      });\n    } catch (err) {\n      console.error('getUserMedia failed', err);\n      setInCall(false);\n      return;\n    }\n    stream.getTracks().forEach(track => pc.addTrack(track, stream));\n    pc.ontrack = e => {\n      if (remoteAudio.current) {\n        remoteAudio.current.srcObject = e.streams[0];\n      }\n    };\n    pc.onicecandidate = event => {\n      if (event.candidate) {\n        socket.emit('ice-candidate', {\n          roomId: rId,\n          candidate: event.candidate\n        });\n      }\n    };\n    if (initiator) {\n      const offer = await pc.createOffer();\n      await pc.setLocalDescription(offer);\n      socket.emit('offer', {\n        roomId: rId,\n        offer\n      });\n    }\n\n    // ensure other tab close / reload notifies server\n    window.onbeforeunload = () => {\n      try {\n        socket.emit('leave', {\n          userId: user.id,\n          roomId: rId\n        });\n      } catch (e) {/* ignore */}\n    };\n  };\n  const leave = () => {\n    if (pc) {\n      try {\n        pc.close();\n      } catch (e) {/* ignore */}\n      pc = null;\n    }\n    if (roomId) {\n      socket.emit('leave', {\n        userId: user.id,\n        roomId\n      });\n    }\n    setInCall(false);\n    setPartner(null);\n    setRoomId(null);\n    // clear unload handler\n    window.onbeforeunload = null;\n  };\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n      children: \"Call\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 135,\n      columnNumber: 7\n    }, this), partner && /*#__PURE__*/_jsxDEV(\"p\", {\n      children: [\"Partner: \", partner.username]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 136,\n      columnNumber: 19\n    }, this), /*#__PURE__*/_jsxDEV(\"audio\", {\n      ref: remoteAudio,\n      autoPlay: true\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 137,\n      columnNumber: 7\n    }, this), !inCall && /*#__PURE__*/_jsxDEV(\"p\", {\n      children: \"Waiting to join call...\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 138,\n      columnNumber: 19\n    }, this), inCall && /*#__PURE__*/_jsxDEV(\"button\", {\n      onClick: leave,\n      children: \"Disconnect\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 139,\n      columnNumber: 18\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 134,\n    columnNumber: 5\n  }, this);\n}\n_s(Call1, \"p4U1AnJnX05CUqdd6AjFlh1bzUA=\");\n_c = Call1;\nvar _c;\n$RefreshReg$(_c, \"Call1\");","map":{"version":3,"names":["React","useEffect","useRef","useState","socket","jsxDEV","_jsxDEV","pc","Call1","user","_s","remoteAudio","inCall","setInCall","partner","setPartner","roomId","setRoomId","emit","userId","id","params","URLSearchParams","window","location","search","roomFromUrl","get","startPeer","catch","err","console","error","onMatched","rId","p","onOffer","offer","setRemoteDescription","answer","createAnswer","setLocalDescription","onAnswer","onIceCandidate","candidate","addIceCandidate","on","close","e","warn","off","onbeforeunload","initiator","RTCPeerConnection","stream","navigator","mediaDevices","getUserMedia","audio","video","getTracks","forEach","track","addTrack","ontrack","current","srcObject","streams","onicecandidate","event","createOffer","leave","children","fileName","_jsxFileName","lineNumber","columnNumber","username","ref","autoPlay","onClick","_c","$RefreshReg$"],"sources":["C:/Users/RK/Downloads/opentalk_voice_app/client/src/pages/Call.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\nimport socket from '../socket'; // <-- yahan se lo, naya mat banao\n\nlet pc;\n\nexport default function Call1({ user }) {\n  const remoteAudio = useRef();\n  const [inCall, setInCall] = useState(false);\n  const [partner, setPartner] = useState(null);\n  const [roomId, setRoomId] = useState(null);\n\n  useEffect(() => {\n    // mark online\n    socket.emit('iamonline', { userId: user.id });\n\n    // if a room was passed via query param (Connect navigates with ?room=...), start as initiator\n    const params = new URLSearchParams(window.location.search);\n    const roomFromUrl = params.get('room');\n    if (roomFromUrl) {\n      setRoomId(roomFromUrl);\n      // startPeer as initiator (true). errors logged.\n      startPeer(roomFromUrl).catch(err => console.error('startPeer error:', err));\n    }\n\n    const onMatched = async ({ roomId: rId, partner: p }) => {\n      setPartner(p);\n      setRoomId(rId);\n      await startPeer(rId);\n    };\n\n    const onOffer = async (offer) => {\n      // ensure peer connection exists for answer\n      if (!pc) await startPeer(roomId, false);\n      // set remote and create/send answer\n      await pc.setRemoteDescription(offer);\n      const answer = await pc.createAnswer();\n      await pc.setLocalDescription(answer);\n      socket.emit('answer', { roomId, answer });\n    };\n\n    const onAnswer = async (answer) => {\n      if (pc) await pc.setRemoteDescription(answer);\n    };\n\n    const onIceCandidate = async (candidate) => {\n      if (pc) await pc.addIceCandidate(candidate);\n    };\n\n    socket.on('matched', onMatched);\n    socket.on('offer', onOffer);\n    socket.on('answer', onAnswer);\n    socket.on('ice-candidate', onIceCandidate);\n\n    return () => {\n      // don't disconnect shared socket here; just cleanup listeners and peer\n      try {\n        if (pc) {\n          pc.close();\n          pc = null;\n        }\n      } catch (e) {\n        console.warn('pc close error', e);\n      }\n\n      socket.off('matched', onMatched);\n      socket.off('offer', onOffer);\n      socket.off('answer', onAnswer);\n      socket.off('ice-candidate', onIceCandidate);\n\n      // remove unload handler\n      window.onbeforeunload = null;\n    };\n  }, []);\n\n  const startPeer = async (rId, initiator = true) => {\n    // create RTCPeerConnection\n    pc = new RTCPeerConnection();\n    setInCall(true);\n\n    // get only audio\n    let stream;\n    try {\n      stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });\n    } catch (err) {\n      console.error('getUserMedia failed', err);\n      setInCall(false);\n      return;\n    }\n\n    stream.getTracks().forEach(track => pc.addTrack(track, stream));\n\n    pc.ontrack = (e) => {\n      if (remoteAudio.current) {\n        remoteAudio.current.srcObject = e.streams[0];\n      }\n    };\n\n    pc.onicecandidate = (event) => {\n      if (event.candidate) {\n        socket.emit('ice-candidate', { roomId: rId, candidate: event.candidate });\n      }\n    };\n\n    if (initiator) {\n      const offer = await pc.createOffer();\n      await pc.setLocalDescription(offer);\n      socket.emit('offer', { roomId: rId, offer });\n    }\n\n    // ensure other tab close / reload notifies server\n    window.onbeforeunload = () => {\n      try {\n        socket.emit('leave', { userId: user.id, roomId: rId });\n      } catch (e) { /* ignore */ }\n    };\n  };\n\n  const leave = () => {\n    if (pc) {\n      try { pc.close(); } catch (e) { /* ignore */ }\n      pc = null;\n    }\n    if (roomId) {\n      socket.emit('leave', { userId: user.id, roomId });\n    }\n    setInCall(false);\n    setPartner(null);\n    setRoomId(null);\n    // clear unload handler\n    window.onbeforeunload = null;\n  };\n\n  return (\n    <div>\n      <h2>Call</h2>\n      {partner && <p>Partner: {partner.username}</p>}\n      <audio ref={remoteAudio} autoPlay />\n      {!inCall && <p>Waiting to join call...</p>}\n      {inCall && <button onClick={leave}>Disconnect</button>}\n    </div>\n  );\n}"],"mappings":";;AAAA,OAAOA,KAAK,IAAIC,SAAS,EAAEC,MAAM,EAAEC,QAAQ,QAAQ,OAAO;AAC1D,OAAOC,MAAM,MAAM,WAAW,CAAC,CAAC;AAAA,SAAAC,MAAA,IAAAC,OAAA;AAEhC,IAAIC,EAAE;AAEN,eAAe,SAASC,KAAKA,CAAC;EAAEC;AAAK,CAAC,EAAE;EAAAC,EAAA;EACtC,MAAMC,WAAW,GAAGT,MAAM,CAAC,CAAC;EAC5B,MAAM,CAACU,MAAM,EAAEC,SAAS,CAAC,GAAGV,QAAQ,CAAC,KAAK,CAAC;EAC3C,MAAM,CAACW,OAAO,EAAEC,UAAU,CAAC,GAAGZ,QAAQ,CAAC,IAAI,CAAC;EAC5C,MAAM,CAACa,MAAM,EAAEC,SAAS,CAAC,GAAGd,QAAQ,CAAC,IAAI,CAAC;EAE1CF,SAAS,CAAC,MAAM;IACd;IACAG,MAAM,CAACc,IAAI,CAAC,WAAW,EAAE;MAAEC,MAAM,EAAEV,IAAI,CAACW;IAAG,CAAC,CAAC;;IAE7C;IACA,MAAMC,MAAM,GAAG,IAAIC,eAAe,CAACC,MAAM,CAACC,QAAQ,CAACC,MAAM,CAAC;IAC1D,MAAMC,WAAW,GAAGL,MAAM,CAACM,GAAG,CAAC,MAAM,CAAC;IACtC,IAAID,WAAW,EAAE;MACfT,SAAS,CAACS,WAAW,CAAC;MACtB;MACAE,SAAS,CAACF,WAAW,CAAC,CAACG,KAAK,CAACC,GAAG,IAAIC,OAAO,CAACC,KAAK,CAAC,kBAAkB,EAAEF,GAAG,CAAC,CAAC;IAC7E;IAEA,MAAMG,SAAS,GAAG,MAAAA,CAAO;MAAEjB,MAAM,EAAEkB,GAAG;MAAEpB,OAAO,EAAEqB;IAAE,CAAC,KAAK;MACvDpB,UAAU,CAACoB,CAAC,CAAC;MACblB,SAAS,CAACiB,GAAG,CAAC;MACd,MAAMN,SAAS,CAACM,GAAG,CAAC;IACtB,CAAC;IAED,MAAME,OAAO,GAAG,MAAOC,KAAK,IAAK;MAC/B;MACA,IAAI,CAAC9B,EAAE,EAAE,MAAMqB,SAAS,CAACZ,MAAM,EAAE,KAAK,CAAC;MACvC;MACA,MAAMT,EAAE,CAAC+B,oBAAoB,CAACD,KAAK,CAAC;MACpC,MAAME,MAAM,GAAG,MAAMhC,EAAE,CAACiC,YAAY,CAAC,CAAC;MACtC,MAAMjC,EAAE,CAACkC,mBAAmB,CAACF,MAAM,CAAC;MACpCnC,MAAM,CAACc,IAAI,CAAC,QAAQ,EAAE;QAAEF,MAAM;QAAEuB;MAAO,CAAC,CAAC;IAC3C,CAAC;IAED,MAAMG,QAAQ,GAAG,MAAOH,MAAM,IAAK;MACjC,IAAIhC,EAAE,EAAE,MAAMA,EAAE,CAAC+B,oBAAoB,CAACC,MAAM,CAAC;IAC/C,CAAC;IAED,MAAMI,cAAc,GAAG,MAAOC,SAAS,IAAK;MAC1C,IAAIrC,EAAE,EAAE,MAAMA,EAAE,CAACsC,eAAe,CAACD,SAAS,CAAC;IAC7C,CAAC;IAEDxC,MAAM,CAAC0C,EAAE,CAAC,SAAS,EAAEb,SAAS,CAAC;IAC/B7B,MAAM,CAAC0C,EAAE,CAAC,OAAO,EAAEV,OAAO,CAAC;IAC3BhC,MAAM,CAAC0C,EAAE,CAAC,QAAQ,EAAEJ,QAAQ,CAAC;IAC7BtC,MAAM,CAAC0C,EAAE,CAAC,eAAe,EAAEH,cAAc,CAAC;IAE1C,OAAO,MAAM;MACX;MACA,IAAI;QACF,IAAIpC,EAAE,EAAE;UACNA,EAAE,CAACwC,KAAK,CAAC,CAAC;UACVxC,EAAE,GAAG,IAAI;QACX;MACF,CAAC,CAAC,OAAOyC,CAAC,EAAE;QACVjB,OAAO,CAACkB,IAAI,CAAC,gBAAgB,EAAED,CAAC,CAAC;MACnC;MAEA5C,MAAM,CAAC8C,GAAG,CAAC,SAAS,EAAEjB,SAAS,CAAC;MAChC7B,MAAM,CAAC8C,GAAG,CAAC,OAAO,EAAEd,OAAO,CAAC;MAC5BhC,MAAM,CAAC8C,GAAG,CAAC,QAAQ,EAAER,QAAQ,CAAC;MAC9BtC,MAAM,CAAC8C,GAAG,CAAC,eAAe,EAAEP,cAAc,CAAC;;MAE3C;MACApB,MAAM,CAAC4B,cAAc,GAAG,IAAI;IAC9B,CAAC;EACH,CAAC,EAAE,EAAE,CAAC;EAEN,MAAMvB,SAAS,GAAG,MAAAA,CAAOM,GAAG,EAAEkB,SAAS,GAAG,IAAI,KAAK;IACjD;IACA7C,EAAE,GAAG,IAAI8C,iBAAiB,CAAC,CAAC;IAC5BxC,SAAS,CAAC,IAAI,CAAC;;IAEf;IACA,IAAIyC,MAAM;IACV,IAAI;MACFA,MAAM,GAAG,MAAMC,SAAS,CAACC,YAAY,CAACC,YAAY,CAAC;QAAEC,KAAK,EAAE,IAAI;QAAEC,KAAK,EAAE;MAAM,CAAC,CAAC;IACnF,CAAC,CAAC,OAAO7B,GAAG,EAAE;MACZC,OAAO,CAACC,KAAK,CAAC,qBAAqB,EAAEF,GAAG,CAAC;MACzCjB,SAAS,CAAC,KAAK,CAAC;MAChB;IACF;IAEAyC,MAAM,CAACM,SAAS,CAAC,CAAC,CAACC,OAAO,CAACC,KAAK,IAAIvD,EAAE,CAACwD,QAAQ,CAACD,KAAK,EAAER,MAAM,CAAC,CAAC;IAE/D/C,EAAE,CAACyD,OAAO,GAAIhB,CAAC,IAAK;MAClB,IAAIrC,WAAW,CAACsD,OAAO,EAAE;QACvBtD,WAAW,CAACsD,OAAO,CAACC,SAAS,GAAGlB,CAAC,CAACmB,OAAO,CAAC,CAAC,CAAC;MAC9C;IACF,CAAC;IAED5D,EAAE,CAAC6D,cAAc,GAAIC,KAAK,IAAK;MAC7B,IAAIA,KAAK,CAACzB,SAAS,EAAE;QACnBxC,MAAM,CAACc,IAAI,CAAC,eAAe,EAAE;UAAEF,MAAM,EAAEkB,GAAG;UAAEU,SAAS,EAAEyB,KAAK,CAACzB;QAAU,CAAC,CAAC;MAC3E;IACF,CAAC;IAED,IAAIQ,SAAS,EAAE;MACb,MAAMf,KAAK,GAAG,MAAM9B,EAAE,CAAC+D,WAAW,CAAC,CAAC;MACpC,MAAM/D,EAAE,CAACkC,mBAAmB,CAACJ,KAAK,CAAC;MACnCjC,MAAM,CAACc,IAAI,CAAC,OAAO,EAAE;QAAEF,MAAM,EAAEkB,GAAG;QAAEG;MAAM,CAAC,CAAC;IAC9C;;IAEA;IACAd,MAAM,CAAC4B,cAAc,GAAG,MAAM;MAC5B,IAAI;QACF/C,MAAM,CAACc,IAAI,CAAC,OAAO,EAAE;UAAEC,MAAM,EAAEV,IAAI,CAACW,EAAE;UAAEJ,MAAM,EAAEkB;QAAI,CAAC,CAAC;MACxD,CAAC,CAAC,OAAOc,CAAC,EAAE,CAAE;IAChB,CAAC;EACH,CAAC;EAED,MAAMuB,KAAK,GAAGA,CAAA,KAAM;IAClB,IAAIhE,EAAE,EAAE;MACN,IAAI;QAAEA,EAAE,CAACwC,KAAK,CAAC,CAAC;MAAE,CAAC,CAAC,OAAOC,CAAC,EAAE,CAAE;MAChCzC,EAAE,GAAG,IAAI;IACX;IACA,IAAIS,MAAM,EAAE;MACVZ,MAAM,CAACc,IAAI,CAAC,OAAO,EAAE;QAAEC,MAAM,EAAEV,IAAI,CAACW,EAAE;QAAEJ;MAAO,CAAC,CAAC;IACnD;IACAH,SAAS,CAAC,KAAK,CAAC;IAChBE,UAAU,CAAC,IAAI,CAAC;IAChBE,SAAS,CAAC,IAAI,CAAC;IACf;IACAM,MAAM,CAAC4B,cAAc,GAAG,IAAI;EAC9B,CAAC;EAED,oBACE7C,OAAA;IAAAkE,QAAA,gBACElE,OAAA;MAAAkE,QAAA,EAAI;IAAI;MAAAC,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAI,CAAC,EACZ9D,OAAO,iBAAIR,OAAA;MAAAkE,QAAA,GAAG,WAAS,EAAC1D,OAAO,CAAC+D,QAAQ;IAAA;MAAAJ,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAI,CAAC,eAC9CtE,OAAA;MAAOwE,GAAG,EAAEnE,WAAY;MAACoE,QAAQ;IAAA;MAAAN,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAE,CAAC,EACnC,CAAChE,MAAM,iBAAIN,OAAA;MAAAkE,QAAA,EAAG;IAAuB;MAAAC,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAG,CAAC,EACzChE,MAAM,iBAAIN,OAAA;MAAQ0E,OAAO,EAAET,KAAM;MAAAC,QAAA,EAAC;IAAU;MAAAC,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAAQ,CAAC;EAAA;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACnD,CAAC;AAEV;AAAClE,EAAA,CAxIuBF,KAAK;AAAAyE,EAAA,GAALzE,KAAK;AAAA,IAAAyE,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}